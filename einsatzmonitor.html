<!doctype html>
<!--suppress NonAsciiCharacters -->
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Freiwillige Feuerwehr Ashausen Einsatzmonitor</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:400,600,700" rel="stylesheet">

    <!-- Bootstrap core CSS -->
    <link href="/static/bootstrap-4.3.1/css/bootstrap.min.css" rel="stylesheet">

    <!-- FontAwesome -->
    <link href="/static/fontawesome-pro-5.0.13/web-fonts-with-css/css/fontawesome-all.min.css" rel="stylesheet">

    <!-- fonts -->
    <link href="/static/css/fonts.css" rel="stylesheet">
</head>

<body>

<style>
    /* Always set the map height explicitly to define the size of the div element that contains the map. */
    .map {
        height: 100%;
    }

    .container {
        #max-width: 1340px;
        max-width: 100%;
    }

    body {
        background: url('https://ff-ashausen.de/static/img/background-compressed.9e24a80e65f3.jpg') no-repeat fixed center center;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;

        padding-bottom: 20px;

        /* Margin bottom by footer height */
        margin-bottom: 230px;

        font-family: 'Titillium Web', sans-serif;
    }

    h1, h2, h3, h4, h5, h6 {
        font-family: "Lato";
    }

    .einsatz-wrapper .jumbotron {
        background: rgb(255, 255, 255); /* This is for ie8 and below */
        background: rgba(255, 255, 255, 0.54);
    }

    .einsatz-wrapper .einsatz-stichwort {
    }

    .einsatz-wrapper .einsatz-stichwort h1 {
        font-size: 50pt;
    }

    .big-text {
        font-size: 50pt;
    }

    .info-card {
        -webkit-border-radius: 1px;
        -moz-border-radius: 1px;
        border-radius: 1px;
        border-top: 3px solid #dc3545;
    }

    .custom-shadow {
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .35);
    }


    /* Dienstplan */
    .dienstplan-table .dienst-entry {
        border: 1px solid #c9c9c9;
    }

    .dienstplan-table .dienst-entry.dienst-today .dienst-date {
        background-color: #cd2a2a !important;
    }

    .dienstplan-table .dienst-entry td:first-child {
        width: 50px;
    }

    .dienstplan-table .dienst-entry .dienst-date {
        display: block;
        float: left;
        height: 50px;
        width: 50px;
    }

    .dienstplan-table .dienst-date-month {
        display: block;
        text-transform: uppercase;
        margin-bottom: -5px;
    }

    .dienstplan-table .dienst-date-day {
        display: block;
        font-size: 1.4rem
    }
</style>

<div class="container">
    <!-- ko if: $root.is_einsatz() -->
    <div class="einsatzmonitor einsatz-wrapper" data-bind="visible: $root.is_einsatz()" style="display: none">
        <h1 class="text-white">Einsatz</h1>

        <div class="einsatz-stichwort jumbotron p-1 m-0" style="border-radius: 0">
            <h1 class="text-danger text-center" data-bind="text: $root.einsatz().stichwort"></h1>
        </div>

        <div class="row mt-2">
            <div class="col-md-5" style="height:600px;">
                <div class="map" id="map-overview"></div>
            </div>
            <div class="col-md-7">
                <div class="map" id="map-route"></div>
            </div>
        </div>

        <div class="einsatz-adresse bg-danger p-2 mt-2">
            <h2 class="text-white text-center m-0" data-bind="text: $root.einsatz().adresse"></h2>
        </div>

        <div class="row mt-2">
            <div class="col-md-9">
                <div class="einsatz-strecke bg-danger p-2 text-white" style="height: 100%;">
                    <table>
                        <tbody>

                        <tr>
                            <td><h5><strong>Zusatzinfo 1</strong></h5></td>
                            <td class="pl-4"><h5>Test</h5></td>
                        </tr>
                        <tr>
                            <td><h5><strong>Zusatzinfo 2</strong></h5></td>
                            <td class="pl-4"><h5>Test 2</h5></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-3">
                <div class="einsatz-strecke bg-warning p-2">
                    <h5 class="text-white text-center m-0" data-bind="text: $root.einsatz().distDuration()"></h5>
                </div>

                <div class="einsatz-adresse bg-info p-2 mt-2">
                    <h1 class="text-white text-center m-0" data-bind="text: $root.einsatz().time_since_alarmierung"></h1>
                    <h5 class="text-white text-center">Minuten seit Alarmierung</h5>
                </div>
            </div>
        </div>
    </div>
    <!-- /ko -->

    <!-- ko if: !$root.is_einsatz() -->
    <div class="einsatzmonitor news-wrapper">
        <h1 class="text-white">News</h1>

        <h1 class="text-white text-center big-text m-0">Freiwillige Feuerwehr Ashausen</h1>
        <h2 class="text-white text-center">derzeit kein Einsatz</h2>

        <div class="d-flex justify-content-center p-4">
            <div class="info-card clock-wrapper bg-white custom-shadow" style="width: 320px;">
                <h1 class="text-danger text-center m-2 big-text" data-bind="text: $root.info().parsed_clock"></h1>
            </div>
        </div>

        <div class="row pt-4 m-2">
            <div class="col col-md-4">
                <h2 class="text-white">Website News</h2>
                <div class="info-card news-wrapper bg-white custom-shadow">
                    <!-- ko foreach: $root.info().sortedNews() -->

                    <!-- <div class="news-post mb-2 shadow mt-1" style="min-height: 120px; position:relative;">
                        <img style="float: left" height="120px" data-bind="attr:{src: image()}" alt="">

                        <p data-bind="text: title()"></p>
                        <p style="position: absolute; bottom: 0; display: inline;" class="m-0" data-bind="text: date()"></p>
                    </div> -->

                    <div class="card mb-3 custom-shadow" style="border: 0; border-radius: 0">
                        <div class="row no-gutters">
                            <div class="col-md-4">
                                <img style="object-fit: cover; height: 100%; border-radius: 0" class="card-img" data-bind="attr:{src: image_url()}" alt="">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body">
                                    <h5 data-bind="text: title()" class="card-title"></h5>
                                    <p class="card-text" data-bind="html: description_truncated()"></p>
                                    <p class="card-text">
                                        <small><i class="far fa-clock mr-1"></i></small>
                                        <small class="text-muted" data-bind="text: date_formatted()"></small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /ko -->
                </div>
            </div>
            <div class="col col-md-4">
                <h2 class="text-white">Eins√§tze</h2>
                <div class="info-card einsaetze-wrapper bg-white custom-shadow">
                    <!-- ko foreach: $root.info().sortedEinsaetze() -->
                    <a data-bind="style: { 'border-left-color': color() }" class="list-group-item list-group-item-action einsatz p-2" style="border-left: 4px solid; cursor: pointer;">
                        <div class="pl-1 mb-0">
                            <small><i class="far fa-clock" aria-hidden="true"></i></small>
                            <small data-bind="text: alarmzeit_formatted()"> 7. Oktober 2018 18:30 | Sirene + DME</small>
                            <br>
                            <p class="m-0" data-bind="text: title()"></p>
                        </div>
                    </a>
                    <!-- /ko -->

                </div>
            </div>
            <div class="col col-md-4">
                <h2 class="text-white">Dienste</h2>
                <div class="info-card dienst-wrapper bg-white shadow">
                    <!-- ko foreach: $root.info().sortedDienste() -->
                    <table class="dienstplan-table" style="width: 100%">
                        <tr class="dienst-entry custom-shadow" data-bind="css: { 'dienst-today': is_today() }">
                            <td>
                                <span class="dienst-date pull-left bg-info">
                                    <span class="dienst-date-month text-center text-white" data-bind="text: startDate().toLocaleString('de-de', { month: 'long' }).substring(0, 3)"></span>
                                    <span class="dienst-date-day text-center text-white" data-bind="text: startDate().getDate()"></span>
                                </span>
                            </td>
                            <td style="max-width: 0;white-space: nowrap; text-overflow: ellipsis;overflow: hidden;">
                                <span class="pl-2">
                                    <i class="far fa-clock" aria-hidden="true"></i> <span data-bind="text: startUhrzeit()"></span>
                                    <i class="far fa-clipboard-list pl-2"></i> <span data-bind="text: title()"></span>
                                </span>
                            </td>
                        </tr>
                        <tr style="height: 3px;"></tr>
                    </table>
                    <!-- /ko -->
                </div>
            </div>
        </div>
    </div>
    <!-- /ko -->

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="/static/js/vendor/popper.min.js"></script>
<script src="/static/bootstrap-4.3.1/js/bootstrap.min.js"></script>

<!-- navigo -->
<script src="/static/js/navigo-6.0.2.js"></script>

<!-- knockoutjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>

<!-- google maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxGT9u3eSlg4n9cPVmAiIOO3CwT7AUniM" type="text/javascript"></script>

<script>
    var win = nw.Window.get();
    //win.setAlwaysOnTop(true);
    $(function () {
        var h = $('.container').height() + 2 * 30;
        console.log(h);
        console.log(win);

        //win.resizeTo(400, h);
        win.resizeTo(1920, 1080);
        win.setResizable(true);
    });
</script>

<script>
    function str_pad_left(string, pad, length) {
        return (new Array(length + 1).join(pad) + string).slice(-length);
    }

    function Einsatz(id, stichwort, alarmzeit, adresse) {
        let self = this;

        self.id = ko.observable(id);
        self.stichwort = ko.observable(stichwort);
        self.alarmzeit = ko.observable(alarmzeit);
        self.adresse = ko.observable(adresse);

        self.time_since_alarmierung = ko.observable("00:00");
        self.distance = ko.observable("0 km");
        self.duration = ko.observable("0 Minuten");
        self.distDuration = ko.computed(function () {
            return self.distance() + " - " + self.duration();
        });

        window.setInterval(function () {
            let now = Date.now() / 1000 | 0;
            let diff = now - self.alarmzeit();

            let minutes = Math.floor(diff / 60);
            let seconds = diff - minutes * 60;
            let finalTime = str_pad_left(minutes, '0', 2) + ':' + str_pad_left(seconds, '0', 2);

            self.time_since_alarmierung(finalTime);

            //Todo: enable
            /*if (minutes >= 30) {
                einsatzMonitorModel.is_einsatz(false);
                einsatzMonitorModel.einsatz(null);
            }*/
        }, 500);

        /* Google Maps Karten */
        let geocoder = new google.maps.Geocoder();
        let feuerwehr = new google.maps.LatLng(53.365934, 10.137550);
        let mapOptions = {
            zoomControl: false,
            fullscreenControl: false,
            streetViewControl: false,
            mapTypeControl: false,
            mapTypeId: 'satellite',
            zoom: 0,
            center: feuerwehr
        };

        geocoder.geocode({'address': self.adresse()}, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                let latitude = results[0].geometry.location.lat();
                let longitude = results[0].geometry.location.lng();
                let latLng = {lat: latitude, lng: longitude};

                /* Overview Map */
                mapOptions['zoom'] = 18;
                mapOptions['center'] = latLng;

                let overview_map = new google.maps.Map(document.getElementById('map-overview'), mapOptions);

                let marker = new google.maps.Marker({
                    position: latLng,
                    map: overview_map,
                    title: 'Einsatzort'
                });

                /* Route */
                let directionsService = new google.maps.DirectionsService();
                let directionsDisplay = new google.maps.DirectionsRenderer();

                let einsatzort = new google.maps.LatLng(latitude, longitude);

                mapOptions['zoom'] = 14;
                mapOptions['mapTypeId'] = 'roadmap';

                let map = new google.maps.Map(document.getElementById('map-route'), mapOptions);
                directionsDisplay.setMap(map);

                let request = {
                    origin: feuerwehr,
                    destination: einsatzort,
                    // Note that Javascript allows us to access the constant
                    // using square brackets and a string value as its
                    // "property."
                    travelMode: google.maps.TravelMode["DRIVING"],
                    region: "de"
                };
                directionsService.route(request, function (response, status) {
                    if (status === 'OK') {
                        directionsDisplay.setDirections(response);

                        // result will contain only 1 route without "alternatives=true"
                        // route will contain only 1 leg with no waypoints
                        let distance = response.routes[0].legs[0].distance.text;
                        let duration = response.routes[0].legs[0].duration.text;

                        self.distance(distance);
                        self.duration(duration);
                    }
                });

            }
        });
    }

    function Info() {
        let self = this;

        self.news = ko.observableArray();
        self.einsaetze = ko.observableArray();
        self.dienste = ko.observableArray();

        self.sortedNews = ko.computed(function () {
            return self.news().sort(function (a, b) {
                return b.id() - a.id();
            });
        });

        self.sortedEinsaetze = ko.computed(function () {
            return self.einsaetze().sort(function (a, b) {
                //return a.id() < b.id() ? -1 : (a.id() > b.id() ? 1 : 0);
                return b.id() - a.id();
                //return a.id() == b.id() ? 0 : (a.id() < b.id() ? -1 : 1)
            });
        });

        // sort by start_date since the newest entry is not always the last dienst
        self.sortedDienste = ko.computed(function () {
            return self.dienste().sort(function (a, b) {
                return a.start() < b.start() ? -1 : (a.start() > b.start() ? 1 : 0);
            });
        });

        self.date = ko.observable(new Date());
        self.parsed_clock = ko.computed(function () {
            return str_pad_left(self.date().getHours(), '0', 2) + ":" + str_pad_left(self.date().getMinutes(), '0', 2) + ":" + str_pad_left(self.date().getSeconds(), '0', 2)
        });

        setInterval(function () {
            self.date(new Date());
        }, 1000 * 1);
    }

    function NewsPost(id, title, image, description_truncated, date_formatted) {
        let self = this;

        self.id = ko.observable(id);
        self.title = ko.observable(title);
        self.image_url = ko.observable(image);
        self.description_truncated = ko.observable(description_truncated);
        self.date_formatted = ko.observable(date_formatted);
    }

    function InfoEinsatz(id, title, alarmzeit, alarmzeit_formatted, color) {
        let self = this;

        self.id = ko.observable(id);
        self.title = ko.observable(title);
        self.alarmzeit = ko.observable(alarmzeit);
        self.alarmzeit_formatted = ko.observable(alarmzeit_formatted);
        self.color = ko.observable(color);
    }

    function Dienst(id, title, description, start, is_today) {
        let self = this;

        self.id = ko.observable(id);
        self.title = ko.observable(title);
        self.description = ko.observable(description);
        self.start = ko.observable(start);
        self.is_today = ko.observable(is_today);

        self.startDate = ko.computed(function () {
            return new Date(self.start());
        });

        self.startUhrzeit = ko.computed(function () {
            return str_pad_left(self.startDate().getHours(), '0', 2) + ":" + str_pad_left(self.startDate().getMinutes(), '0', 2)
        });
    }

    /*----------------------------------------------------------------------*/
    /* View Model
    /*----------------------------------------------------------------------*/
    function EinsatzMonitorModel() {
        var self = this;

        self.is_einsatz = ko.observable(false);
        self.einsatz = ko.observable();

        self.info = ko.observable(new Info());
    }

    einsatzMonitorModel = new EinsatzMonitorModel();
    //einsatzMonitorModel.is_einsatz(true);
    //einsatzMonitorModel.einsatz(new Einsatz(1, "F3 Brennt landwirtschaftliches Geb√§ude", 1556217316, "Bahnhofstra√üe 39 Ashausen"));

    let config = require('./config.js');

    self.check_einsatz();
    self.loadInfoData();

    window.setInterval(function () {
        self.check_einsatz();
        self.loadInfoData();
    }, 1000 * 10);

    function check_einsatz() {
        $.ajax({
            type: 'GET',
            url: config.einsatzmonitor_url,
            datatype: "json",
            contentType: "application/json charset=utf-8",
            success: function (data) {
                data.forEach(function (einsatz) {
                    if (!ko.unwrap(einsatzMonitorModel.is_einsatz())) {
                        console.log(einsatz.id + " now being displayed");
                        einsatzMonitorModel.einsatz(new Einsatz(einsatz.id, einsatz.stichwort, einsatz.alarmzeit_seconds, einsatz.adresse));
                        einsatzMonitorModel.is_einsatz(true);
                        return;
                    }

                    // current einsatz is already shown
                    if (ko.unwrap(einsatzMonitorModel.einsatz().id) === einsatz.id) {
                        // console.log(einsatz.id + " is already displayed");
                        return;
                    }

                    // we have a new einsatz waiting
                    // console.log(einsatz.id + " is waiting to get displayed");
                })
            }
        });
    }

    function loadInfoData() {
        $.ajax({
            type: 'GET',
            url: config.news_url,
            datatype: "json",
            contentType: "application/json charset=utf-8",
            success: function (data) {
                let news = [];

                data.forEach(function (news_post) {
                    news.push(news_post.id);

                    let new_newsPost = new NewsPost(news_post.id, news_post.title, news_post.images[0].image_url, news_post.description_truncated, news_post.date_formatted);

                    var match = ko.utils.arrayFirst(einsatzMonitorModel.info().news(), function (item) {
                        return new_newsPost.id() === item.id();
                    });

                    // News not in array, add it
                    if (!match) {
                        einsatzMonitorModel.info().news.push(new_newsPost)
                    } else {
                        updateModel(match, news_post);
                        match.image_url(news_post.images[0].image_url);
                    }
                });

                einsatzMonitorModel.info().news().forEach(function (item) {
                    if ($.inArray(item.id(), news) == "-1") {
                        einsatzMonitorModel.info().news.remove(item);
                    }
                });
            }
        });

        $.ajax({
            type: 'GET',
            url: config.einsatz_url,
            datatype: "json",
            contentType: "application/json charset=utf-8",
            success: function (data) {
                let einsaetze = [];

                data.forEach(function (einsatz) {
                    einsaetze.push(einsatz.id);

                    let new_einsatz = new InfoEinsatz(einsatz.id, einsatz.title, einsatz.alarmzeit, einsatz.alarmzeit_formatted, einsatz.color);

                    var match = ko.utils.arrayFirst(einsatzMonitorModel.info().einsaetze(), function (item) {
                        return new_einsatz.id() === item.id();
                    });

                    // Einsatz not in array, add it
                    if (!match) {
                        einsatzMonitorModel.info().einsaetze.push(new_einsatz);
                    } else {
                        updateModel(match, einsatz);
                    }
                });

                einsatzMonitorModel.info().einsaetze().forEach(function (item) {
                    if ($.inArray(item.id(), einsaetze) == "-1") {
                        einsatzMonitorModel.info().einsaetze.remove(item);
                    }
                });
            }
        });

        $.ajax({
            type: 'GET',
            url: config.dienst_url,
            datatype: "json",
            contentType: "application/json charset=utf-8",
            success: function (data) {
                let dienste = [];

                data.forEach(function (dienst) {
                    dienste.push(dienst.id);

                    let new_dienst = new Dienst(dienst.id, dienst.title, dienst.description, dienst.start, dienst.is_today);

                    var match = ko.utils.arrayFirst(einsatzMonitorModel.info().dienste(), function (item) {
                        return new_dienst.id() === item.id();
                    });

                    // Einsatz not in array, add it
                    if (!match) {
                        einsatzMonitorModel.info().dienste.push(new_dienst);
                    } else {
                        updateModel(match, dienst);
                    }
                });

                einsatzMonitorModel.info().dienste().forEach(function (item) {
                    if ($.inArray(item.id(), dienste) == "-1") {
                        einsatzMonitorModel.info().dienste.remove(item);
                    }
                });
            }
        });
    }

    let auto_update_fields = ["id", "title", "description", "description_truncated", "date_formatted", "alarmzeit", "alarmzeit_formatted", "color", "start", "is_today"];

    // loop over knockout model fields and update with values from json response
    function updateModel(model, json) {
        $.each(model, function (k, v) {
            if (auto_update_fields.includes(k)) {
                if (json[k]) {
                    model[k](json[k])
                }
            }
        });
    }

    ko.applyBindings(einsatzMonitorModel);
</script>

</body>
</html>
